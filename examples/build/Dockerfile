# Stage 1: Build
FROM golang:1.25.5-alpine AS builder

ARG VERSION=dev
ARG COMMIT=unknown
ARG DATE=unknown

WORKDIR /build

COPY go.mod go.sum ./
RUN go mod download

COPY . .

ENV CGO_ENABLED=0 GOOS=linux
RUN go build -trimpath \
    -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}" \
    -o /build/g0efilter ./cmd/g0efilter

# Stage 2: Runtime
FROM alpine:3.23.2

RUN apk add --no-cache nftables ca-certificates \
    && update-ca-certificates

WORKDIR /app

COPY --from=builder /build/g0efilter /app/g0efilter

ENTRYPOINT ["/app/g0efilter"]
